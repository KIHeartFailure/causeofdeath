```{r incplotfunc, cache=cacheon}

incdatafunc <- function(timevar, eventvar, data) {
  timedata <- rsdata %>%
    group_by(shf_ef_cat) %>%
    summarise(time = sum(!!sym(timevar))) %>%
    ungroup()

  outdata <- data %>%
    mutate(!!sym(eventvar) := droplevels(!!sym(eventvar))) %>%
    group_by(shf_ef_cat) %>%
    count(!!sym(eventvar), .drop = F) %>%
    ungroup()
  outdata <- left_join(outdata, timedata, by = "shf_ef_cat") %>%
    mutate(inc = n / ((time / 365.25) / 1000)) %>%
    rename(outvar = !!sym(eventvar))
  return(outdata)
}

incplotfunc <- function(timevar, eventvar, data, ylimmin = 60, name) {
  incdata <- incdatafunc(timevar = timevar, eventvar = eventvar, data = data)

  cat2 <- str_detect(eventvar, "sos_deathcause_cat2")
  
  cexmy <- 1
  # c(bottom, left, top, right)
  if (cat2) {
    par(mar = c(6, 4, .5, 0) + 0.1)
  }
  if (!cat2) {
    par(mar = c(8, 4, .5, 0) + 0.1)
  }

  b <- barplot(inc ~ shf_ef_cat + outvar,
    data = incdata,
    beside = T,
    col = global_cols[c(2, 5, 8)],
    border = "white",
    xlab = "",
    ylab = "Incidence rate/1000 py",
    axes = FALSE,
    cex.lab = cexmy,
    cex.names = cexmy,
    ylim = c(0, ylimmin),
    names.arg = rep("", nlevels(incdata$outvar))
  )

  axis(2, cex.axis = cexmy, las = 2)

  axis(1,
    at = c(b), rep(levels(incdata$shf_ef_cat), nlevels(incdata$outvar)),
    tick = F, line = ifelse(cat2, 0, -0.5),
    las = ifelse(cat2, 1, 2),
  )

  axis(1,
    at = b[2, ], levels(incdata$outvar),
    tick = F, line = ifelse(cat2, 2, 3.5)
  )

  axis(1,
    at = mean(b[2, ]), name,
    tick = F, line = ifelse(cat2, 4, 6)
  )

  text(
    x = c(b), y = incdata %>% arrange(outvar, shf_ef_cat) %>% pull(inc),
    pos = 3,
    label = fn(incdata %>% arrange(outvar, shf_ef_cat) %>% pull(inc), 1),
    cex = cexmy
  )
}
```

```{r incplot22y, cache=cacheon, fig.cap="Incidence CV/Non-CV Death by EF 2 years follow-up", dependson="incplotfunc"}

incplotfunc(
  timevar = "sos_outtime_death_2y",
  eventvar = "sos_deathcause_cat2_2y",
  data = rsdata %>% filter(sos_deathcause_cat2_2y != "Alive"),
  ylimmin = 120,
  name = "Cause of Death"
)
```

```{r incplot2, cache=cacheon, fig.cap="Incidence CV/Non-CV Death by EF long term follow-up", dependson="incplotfunc"}

incplotfunc(
  timevar = "sos_outtime_death",
  eventvar = "sos_deathcause_cat2",
  data = rsdata %>% filter(sos_deathcause_cat2 != "Alive"),
  ylimmin = 120,
  name = "Cause of Death"
)
```

```{r incplotcv2y, cache=cacheon, fig.cap="Incidence CV Death by EF 2 years follow-up", dependson="incplotfunc"}

incplotfunc(
  timevar = "sos_outtime_death_2y",
  eventvar = "sos_deathcause_cat_2y",
  data = rsdata %>% filter(!is.na(sos_deathcause_cat_2y) & sos_deathcause_cat2_2y == "CV"),
  ylimmin = 60,
  name = "Cause of CV Death"
)
```

```{r incplotcv, cache=cacheon, fig.cap="Incidence CV Death by EF long term follow-up", dependson="incplotfunc"}

incplotfunc(
  timevar = "sos_outtime_death",
  eventvar = "sos_deathcause_cat",
  data = rsdata %>% filter(!is.na(sos_deathcause_cat) & sos_deathcause_cat2 == "CV"),
  ylimmin = 60,
  name = "Cause of CV Death"
)
```

```{r incplotnoncv2y, cache=cacheon, fig.cap="Incidence Non-CV Death by EF 2 years follow-up", dependson="incplotfunc"}

incplotfunc(
  timevar = "sos_outtime_death_2y",
  eventvar = "sos_deathcause_cat_2y",
  data = rsdata %>% filter(!is.na(sos_deathcause_cat_2y) & sos_deathcause_cat2_2y == "Non-CV"),
  ylimmin = 60,
  name = "Cause of Non-CV Death"
)
```

```{r incplotnoncv, cache=cacheon, fig.cap="Incidence Non-CV Death by EF long term follow-up", dependson="incplotfunc"}

incplotfunc(
  timevar = "sos_outtime_death",
  eventvar = "sos_deathcause_cat",
  data = rsdata %>% filter(!is.na(sos_deathcause_cat) & sos_deathcause_cat2 == "Non-CV"),
  ylimmin = 60,
  name = "Cause of Non-CV Death"
)
```
